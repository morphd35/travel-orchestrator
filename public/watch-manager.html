<!DOCTYPE html>
<html>
<head>
    <title>Watch Manager - Travel Orchestrator FIXED</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 0; 
            margin: 0;
            background: #f5f6fa;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .header h1 { 
            margin: 0 0 10px 0; 
            color: #2c3e50; 
        }
        .header p { 
            color: #7f8c8d; 
            margin: 0 0 20px 0; 
        }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            text-decoration: none; 
            display: inline-block; 
            margin: 5px; 
            transition: all 0.2s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .watch-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .watch-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            border: 1px solid #e9ecef;
        }
        .watch-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .watch-route { 
            font-size: 20px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .watch-status { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
            text-transform: uppercase; 
        }
        .watch-status.active { 
            background: #d4edda; 
            color: #155724; 
        }
        .watch-status.paused { 
            background: #f8d7da; 
            color: #721c24; 
        }
        .system-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        .system-badge.edge { 
            background: #e3f2fd; 
            color: #1565c0; 
        }
        .system-badge.api { 
            background: #f3e5f5; 
            color: #7b1fa2; 
        }
        .watch-target { 
            font-size: 24px; 
            font-weight: bold; 
            color: #27ae60; 
            margin: 10px 0; 
        }
        .watch-details { 
            color: #6c757d; 
            font-size: 14px; 
            line-height: 1.5; 
            margin-bottom: 20px; 
        }
        .watch-details div { 
            margin-bottom: 5px; 
        }
        .button-group { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        .button-group .btn { 
            margin: 0; 
            font-size: 14px; 
            padding: 8px 16px; 
        }
        .loading { 
            text-align: center; 
            padding: 50px; 
            color: #6c757d; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        /* Navigation */
        nav { 
            background: white; 
            border-bottom: 1px solid #e0e0e0; 
            padding: 10px 0; 
            margin-bottom: 20px; 
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/" style="text-decoration: none; color: #007bff; font-weight: bold; font-size: 18px;">
                ‚úàÔ∏è Travel Orchestrator
            </a>
            <div style="display: flex; gap: 15px;">
                <a href="/" style="text-decoration: none; color: #666; font-size: 14px;">üè† Home</a>
                <a href="/watch-manager.html" style="text-decoration: none; color: #007bff; font-size: 14px; font-weight: bold;">üëÅÔ∏è My Watches</a>
                <a href="/test-watch.html" style="text-decoration: none; color: #666; font-size: 14px;">‚ûï Create Watch</a>
                <a href="/test-amadeus.html" style="text-decoration: none; color: #666; font-size: 14px;">üîç Flight Search</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Watch Manager</h1>
            <p>Manage your flight price watches from both Edge and API systems</p>
            <button class="btn btn-primary" onclick="loadWatches()">üîÑ Refresh Watches</button>
            <a href="/test-watch.html" class="btn btn-success">‚ûï Create New Watch</a>
            <a href="/" class="btn btn-primary">üè† Back to Home</a>
        </div>
        
        <div id="watchesContainer">
            <div class="loading">Loading watches...</div>
        </div>
    </div>

    <script>
        let watches = [];

        async function loadWatches() {
            const container = document.getElementById('watchesContainer');
            container.innerHTML = '<div class="loading">Loading watches...</div>';

            try {
                // Load from both systems
                const [edgeRes, apiRes] = await Promise.all([
                    fetch('/edge/watch').catch(() => ({ ok: false })),
                    fetch('/api/price-watch').catch(() => ({ ok: false }))
                ]);

                const allWatches = [];

                // Process Edge system watches
                if (edgeRes.ok) {
                    const edgeData = await edgeRes.json();
                    const edgeWatches = edgeData.watches || [];
                    console.log('‚úÖ Edge system loaded:', edgeWatches.length, 'watches');
                    
                    edgeWatches.forEach(w => {
                        allWatches.push({
                            id: w.id,
                            system: 'edge',
                            systemLabel: 'Edge System',
                            origin: w.origin,
                            destination: w.destination,
                            route: `${w.origin} ‚Üí ${w.destination}`,
                            targetUsd: w.targetUsd,
                            start: w.start,
                            end: w.end,
                            cabin: w.cabin,
                            adults: w.adults,
                            maxStops: w.maxStops,
                            flexDays: w.flexDays,
                            active: w.active,
                            lastBestUsd: w.lastBestUsd,
                            lastNotifiedUsd: w.lastNotifiedUsd,
                            createdAt: w.createdAt
                        });
                    });
                }

                // Process API system watches
                if (apiRes.ok) {
                    const apiData = await apiRes.json();
                    const apiWatches = apiData.watches || [];
                    console.log('‚úÖ API system loaded:', apiWatches.length, 'watches');
                    
                    apiWatches.forEach(w => {
                        allWatches.push({
                            id: w.id,
                            system: 'api',
                            systemLabel: 'API System',
                            origin: w.route?.split(' ‚Üí ')[0] || 'Unknown',
                            destination: w.route?.split(' ‚Üí ')[1] || 'Unknown',
                            route: w.route || 'Unknown ‚Üí Unknown',
                            targetUsd: w.targetPrice || w.baselinePrice,
                            start: 'API System',
                            end: 'API System',
                            cabin: 'ECONOMY',
                            adults: 1,
                            maxStops: 2,
                            flexDays: 0,
                            active: w.isActive,
                            lastBestUsd: w.baselinePrice,
                            lastNotifiedUsd: null,
                            createdAt: w.createdAt
                        });
                    });
                }

                watches = allWatches;
                console.log('üìä Total watches loaded:', watches.length);

                if (watches.length === 0) {
                    container.innerHTML = '<div class="error">No watches found. <a href="/test-watch.html">Create your first watch</a></div>';
                    return;
                }

                displayWatches();

            } catch (error) {
                console.error('‚ùå Error loading watches:', error);
                container.innerHTML = '<div class="error">Failed to load watches: ' + error.message + '</div>';
            }
        }

        function displayWatches() {
            const container = document.getElementById('watchesContainer');
            
            const watchCards = watches.map(watch => `
                <div class="watch-card">
                    <div class="watch-header">
                        <div class="watch-route">${watch.route}</div>
                        <div>
                            <span class="watch-status ${watch.active ? 'active' : 'paused'}">
                                ${watch.active ? 'Active' : 'Paused'}
                            </span>
                            <span class="system-badge ${watch.system}">
                                ${watch.systemLabel}
                            </span>
                        </div>
                    </div>
                    
                    <div class="watch-target">Target: $${watch.targetUsd}</div>
                    
                    <div class="watch-details">
                        <div><strong>Dates:</strong> ${watch.start} to ${watch.end}</div>
                        <div><strong>Cabin:</strong> ${watch.cabin} ‚Ä¢ <strong>Adults:</strong> ${watch.adults} ‚Ä¢ <strong>Max Stops:</strong> ${watch.maxStops}</div>
                        <div><strong>Flexibility:</strong> ¬±${watch.flexDays} days</div>
                        <div><strong>Last Best:</strong> ${watch.lastBestUsd ? '$' + watch.lastBestUsd : 'Not checked'}</div>
                        <div><strong>Last Notified:</strong> ${watch.lastNotifiedUsd ? '$' + watch.lastNotifiedUsd : 'Never'}</div>
                        <div><strong>Created:</strong> ${new Date(watch.createdAt).toLocaleDateString()}</div>
                        <div><strong>System:</strong> ${watch.systemLabel}</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="checkWatch('${watch.id}', '${watch.system}')">
                            üîç Check Now
                        </button>
                        <button class="btn btn-warning" onclick="editWatch('${watch.id}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteWatch('${watch.id}', '${watch.system}')">
                            üóëÔ∏è Delete
                        </button>
                        <button class="btn ${watch.active ? 'btn-warning' : 'btn-success'}" onclick="toggleActive('${watch.id}', '${watch.system}')">
                            ${watch.active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Activate'}
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = '<div class="watch-grid">' + watchCards + '</div>';
        }

        async function checkWatch(watchId, system) {
            alert(`Checking watch ${watchId} in ${system} system...`);
        }

        async function editWatch(watchId) {
            const watch = watches.find(w => w.id === watchId);
            if (!watch) return;
            
            const newTarget = prompt(`Edit target price for ${watch.route}:`, watch.targetUsd);
            if (newTarget && !isNaN(newTarget)) {
                // Here you would call the API to update the watch
                alert(`Updated target price to $${newTarget} (functionality pending)`);
            }
        }

        async function deleteWatch(watchId, system) {
            const watch = watches.find(w => w.id === watchId);
            if (!watch) return;

            if (!confirm(`Are you sure you want to delete the watch for ${watch.route}?`)) {
                return;
            }
            
            try {
                const endpoint = system === 'edge' ? `/edge/watch?id=${watchId}` : `/api/price-watch?id=${watchId}`;
                const response = await fetch(endpoint, { method: 'DELETE' });
                
                if (response.ok) {
                    await loadWatches(); // Refresh to show removal
                    alert('‚úÖ Watch deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('‚ùå Delete failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Delete failed: ' + error.message);
            }
        }

        async function toggleActive(watchId, system) {
            const watch = watches.find(w => w.id === watchId);
            if (!watch) return;
            
            try {
                const endpoint = system === 'edge' ? `/edge/watch?id=${watchId}` : `/api/price-watch?id=${watchId}`;
                const updateField = system === 'edge' ? { active: !watch.active } : { isActive: !watch.active };
                
                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateField)
                });
                
                if (response.ok) {
                    await loadWatches(); // Refresh to show changes
                    alert(`‚úÖ Watch ${watch.active ? 'paused' : 'activated'} successfully!`);
                } else {
                    const error = await response.json();
                    alert('‚ùå Status change failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Status change failed: ' + error.message);
            }
        }

        // Load watches when page loads
        window.addEventListener('load', loadWatches);
    </script>
</body>
</html>
